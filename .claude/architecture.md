# コアアーキテクチャガイド

## ページベースルーティングシステム

`src/main.ts`でURL基盤のルーティングシステムを使用し、異なるTwitter/Xページを特定の機能にマッピング：

- **ホーム/探索/検索ページ**: ツイートの自動クロールとスクロール
- **ツイートページ**: 個別ツイートのインタラクション処理
- **特別ページ**: ログイン、アカウントロック、サンプルエンドポイントの処理
- **URLマッチング**: 文字列マッチング（`startsWith`）と正規表現パターンの両方を使用

## サービス層アーキテクチャ

### CrawlerService

メインのツイートクロールワークフローを統制

- 定期的にツイートを自動クロール
- エンゲージメント閾値でツイートをフィルタリング（リツイート100+、リプライ10+）
- クロール状態とカウントを管理

### TweetService

ツイートの抽出と保存を処理

- 特定のセレクターを使用してDOMからツイートを抽出
- エンゲージメント指標（リツイート、リプライ、いいね）を解析
- ツイートの保存と自動ダウンロードを管理

### QueueService

ツイート処理キューを管理

- localStorageを使用して「待機中」と「確認済み」のツイートリストを維持
- 処理に応じてツイートを状態間で移動
- 重複処理を防止

### NotificationService

アラート用のDiscord webhook統合

## データフロー

1. **クロール**: CrawlerServiceがツイートを抽出 → TweetServiceがエンゲージメントでフィルタリング → QueueServiceが待機キューに追加
2. **処理**: ページが待機中のツイートを処理 → QueueServiceが確認済み状態に移動
3. **保存**: TweetServiceが500ツイート制限に達すると自動ダウンロード

## ストレージシステム

永続化にGM_getValue/GM_setValue（ユーザースクリプトAPI）を使用：

- `waitingTweets`: 処理待ちのツイートIDの配列
- `checkedTweets`: 処理済みツイートIDの配列
- `savedTweets`: エクスポート用の完全なツイートオブジェクト
- `config`: ユーザー設定

## DOM操作パターン

- サイトの変更に応じて更新が必要な可能性があるX.com固有のDOMセレクターを使用
- スクロール自動化と「さらに読み込む」ボタンのクリックを実装
- タイムアウトベースの待機で動的コンテンツの読み込みを処理

## サービス層の依存関係

- **CrawlerService** → TweetService, QueueService, NotificationService
- **TweetService** → DOM操作, StorageAPI
- **QueueService** → StorageAPI
- **StateService** → 状態管理ユーティリティ

## 定数とグローバル値

`src/core/constants.ts`で管理：

- エンゲージメント閾値（リツイート100+、リプライ10+）
- タイムアウト値（クロール、スクロール、要素待機）
- 自動ダウンロード閾値（500ツイート）
